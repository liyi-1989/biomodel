{
    "contents" : "---\ntitle: \"hierarchical_model_v2\"\nauthor: \"Yi Li\"\ndate: \"08/18/2015\"\noutput: pdf_document\n---\n\n\n# 1. Review\n\nThree important elements at location $x$, time $t$.:\n\n- Larval production ($L_{x, t}$), \n- recruitment ($R_{x, t}$),\n- adult abundance ($A_{x, t}$),\n\ntogether with the environment features $E_{x,t}$\n\nThree stages:\n\n- Larval production: \n\\[\nL_{x, t} = f \\left( A_{x, t}, E_{x, t} \\right) = p_{x, t} \\cdot A_{x, t} \\cdot E_{x, t}\n\\]\n- Recruitment\n\\[\nR_{x, t} = k + \\log\\left(\\sum_{i=1}^N L_{i, t} \\cdot e^{-\\frac{\\left(d_{x,i} - \\mu_d\\right)^2}{\\sigma^2_d}} \\right) + \\beta \\cdot E_{x, t} + \\epsilon\n\\]\n- Adult abundance\n\\[\nA_{x, t+1} = b \\cdot R_{x, t} \\cdot E_{x, t+1}\n\\]\n\n# 2. Update to second order of the environment feature\n## 2.1 Larval production: \n\\[\n\\log L_{x, t} = (\\log A_{x, t}) (\\beta_0+\\beta_1E_{x, t}+\\beta_2E_{x, t}^2) \n\\]\n\nThis is equivalent to \n\\[\nL_{x, t} =  A_{x, t}e^{\\beta_0+\\beta_1E_{x, t}+\\beta_2E_{x, t}^2}\n\\]\n\n## 2.2 Recruitment\n\\[\n\\log R_{x, t} = k + \\log\\left(\\sum_{i=1}^N L_{i, t} \\cdot e^{-\\frac{\\left(d_{x,i} - \\mu_d\\right)^2}{\\sigma^2_d}} \\right) + \\beta_3E_{x, t}+ \\beta_4E_{x, t}^2 + \\epsilon\n\\]\n\nWe don't have data for $L_{x,t}$, but we can plug $L_{x,t}$(from 2.1) in the above equation:\n\n\\[\n\\log R_{x, t} = k + \\log\\left(\\sum_{i=1}^N A_{i, t} \\cdot e^{\\beta_0+\\beta_1E_{i, t}+\\beta_2E_{i, t}^2-\\frac{\\left(d_{x,i} - \\mu_d\\right)^2}{\\sigma^2_d}} \\right) + \\beta_3E_{x, t}+ \\beta_4E_{x, t}^2 + \\epsilon\n\\]\n\n## 2.3 Adult abundance\n\\[\nA_{x, t+1} = R_{x, t}e^{\\beta_6+\\beta_7E_{x, t+1}+\\beta_8E_{x, t+1}^2}+mA_{x,t}\n\\]\n\n# 3. Two stages model\n## 3.1 Model 1\n\\[\n\\log R_{x, t} = \\log\\left(\\sum_{i=1}^N A_{i, t} \\cdot e^{p_4 + p_5E_{i, t} - p_6E_{i, t}^2 + p_7d_{x,i} - p_8d_{x,i}^2} \\right) + p_1+ p_2E_{x, t} - p_3E_{x, t}^2 + \\epsilon\n\\]\n\n\nNote that:\n\n- Unimodality of the environment: coefficient of the second order term is negative\n- $argmax(-ax^2+bx)=\\frac{b}{2a}$ implies $E^*$ occurs at $\\frac{p_5}{2p_6}$ and $\\frac{p_2}{2p_3}$\n- Dispersal parameters: $\\mu_d=\\frac{p_7}{2p_8}$, $\\sigma_d=\\frac{1}{\\sqrt{p_8}}$\n\n## 3.2 Adult abundance\n\\[\nA_{x, t+1} = R_{x, t}e^{p_2+p_3E_{x, t+1}+p_4E_{x, t+1}^2}+p_1A_{x,t}\n\\]\n\nNote that:\n\n- This is the growth from $t$ to $t+1$. may try environment variable $E_{x,t}$ or $E_{x,t+1}$\n\n\n# 4. Code and Results\n\n## 4.1 load the data\n\n```{r}\nX=read.csv(\"~/Dropbox/model/adults.recruits.merged.csv\")\nfeature_name=c(\"year\",\"lat\",\"lon\",\"sitenum\",\"cover\",\n               \"filter_chla_mean\",\"filter_sst_mean\",\"filter_upw_mean\",\"mytilus.rec\")\nX=X[feature_name]\n```\n\n## 4.2 derive new variables\n\n- next year abundance: $y=A_{x,t+1}$, target variable\n\n\n```{r}\nnsample=dim(X)[1]\nX[\"ycover\"]=NA\nfor(i in 1:nsample){\n  idx=(X[,\"sitenum\"]==X[i,\"sitenum\"])&(X[,\"year\"]==X[i,\"year\"]+1)\n  if(sum(idx)){ # if no next value, will be NA\n    X[i,\"ycover\"]=X[idx,\"cover\"]\n  }\n}\n```\n\n- next year environment: $E_{x,t+1}$, will be used in model 2\n\n```{r}\nX[\"new_upw\"]=NA\nX[\"new_chla\"]=NA\nX[\"new_sst\"]=NA\nfor(i in 1:nsample){\n  idx=(X[,\"sitenum\"]==X[i,\"sitenum\"])&(X[,\"year\"]==X[i,\"year\"]+1)  \n  if(sum(idx)){ # if no next value, will be NA\n    X[i,\"new_upw\"]=X[idx,\"filter_upw_mean\"]\n    X[i,\"new_chla\"]=X[idx,\"filter_chla_mean\"]\n    X[i,\"new_sst\"]=X[idx,\"filter_sst_mean\"]\n    \n  }\n}\n```\n\nFind the complete observations and relabel the site number. Note that we only have one observation for site number 8. And after relabeling, site labels are increaseing with latitude. \n\n```{r}\nX1=X[complete.cases(X),]\n\nlats=subset(X1,year==2001,select = c(lat))[,1]\nlons=subset(X1,year==2001,select = c(lon))[,1]\nlats=floor(lats*1000)\nlons=floor(lons*1000)\n# unique identifier of each site, sorted by lats\n# using both lat and lon, because there are two sites have the same lat(but different lon)\nlatlon=paste0(lats,lons) \n\nfor(i in 1:dim(X1)[1]){\n  X1[i,\"sitenum\"]=which(latlon==paste0(floor(X1[i,\"lat\"]*1000),floor(X1[i,\"lon\"]*1000)))\n}\n```\n\n- Target variable in model 1: Recruitment $R_{x,t}$\n\n```{r}\nR=X1[,\"mytilus.rec\"]\nR[R==0]=min(R[R!=0])/2\nR=log(R)\n```\n\n- Target variable in model 2: next year abundance $y=A_{x,t+1}$\n\n```{r}\ny=X1[,\"ycover\"]\ny[y==0]=min(y[y!=0])/2 # replace 0 to the minimum positive number\ny=log(y) # take log of the species number\n```\n\n- Distance Matrix\n\n```{r}\nD=dist(X1[X1[,\"year\"]==2001,\"lat\"],diag = T,upper = T)\nD=as.matrix(D)\nfor(i in 1:48){\n  for(j in 1:48){\n    if(i>j){\n      D[i,j]=-D[i,j]\n    }\n  }\n}\n```\n\nRescale the environment variables, record the mean and standard deviation. \n\n```{r}\nmean_upw=mean(X1[,\"filter_upw_mean\"])\nsd_upw=sd(X1[,\"filter_upw_mean\"])\nX1[,\"filter_upw_mean\"]=(X1[,\"filter_upw_mean\"]-mean_upw)/sd_upw\n```\n\n## 4.3 Fit model 1\n\n\\[\n\\log R_{x, t} = \\log\\left(\\sum_{i=1}^N A_{i, t} \\cdot e^{p_4 + p_5E_{i, t} - p_6E_{i, t}^2 + p_7d_{x,i} - p_8d_{x,i}^2} \\right) + p_1+ p_2E_{x, t} - p_3E_{x, t}^2 + \\epsilon\n\\]\n\nThe input of the (maximum) likelihood function, which is equivalent to least square, are\n\n- eight parameters\n- data\n- target recruitment\n- distance matrix\n\n```{r}\nm1logl=function(p,X1,R,D){\n  n=dim(X1)[1]\n  f=rep(0,n)\n  for(iobs in 1:n){\n    this_ker=0\n    this_site=X1[iobs,\"sitenum\"]\n    this_year=X1[iobs,\"year\"]\n    # all the sites that have the same year as the current observation\n    Xtemp=subset(X1,year==this_year)\n    for(j in dim(Xtemp)[1]){\n      sitej=Xtemp[j,\"sitenum\"]\n      this_ker=this_ker+Xtemp[j,\"cover\"]*\n        exp(p[4]+p[5]*Xtemp[j,\"filter_upw_mean\"]-p[6]*Xtemp[j,\"filter_upw_mean\"]^2\n            +p[7]*D[this_site,sitej]-p[8]*D[this_site,sitej]^2)\n    }\n    #print(this_ker)\n    f[iobs]=log(this_ker)+p[1]+p[2]*X1[iobs,\"filter_upw_mean\"]-p[3]*X1[iobs,\"filter_upw_mean\"]^2\n  }\n  return(sum((R-f)^2))\n}\n```\n\n```{r, cache=TRUE}\np0=c(0,1,1,0,1,1,1,1)/10\nresm1=nlm(m1logl,p0,hessian=T,print.level=0,X1=X1,R=R,D=D,iterlim=1e4,steptol=1e-5)\np1=resm1$estimate\np1\n```\n\n```{r}\nmu_hat=p1[7]/(2*p1[8])\nsigma_hat=1/sqrt(p1[8])\nE_in=p1[5]/(2*p1[6])\nE_out=p1[2]/(2*p1[3])\nmu_hat\nsigma_hat\nE_in*sd_upw+mean_upw\nE_out*sd_upw+mean_upw\n```\n\n```{r}\nm1pred=function(p,X1,R,D){\n  n=dim(X1)[1]\n  f=rep(0,n)\n  for(iobs in 1:n){\n    this_ker=0\n    this_site=X1[iobs,\"sitenum\"]\n    this_year=X1[iobs,\"year\"]\n    Xtemp=subset(X1,year==this_year)# all the sites that have the same year as the current observation\n    for(j in dim(Xtemp)[1]){\n      sitej=Xtemp[j,\"sitenum\"]\n      this_ker=this_ker+Xtemp[j,\"cover\"]*\n        exp(p[4]+p[5]*Xtemp[j,\"filter_upw_mean\"]-p[6]*Xtemp[j,\"filter_upw_mean\"]^2\n            +p[7]*D[this_site,sitej]-p[8]*D[this_site,sitej]^2)\n    }\n    #print(this_ker)\n    f[iobs]=log(this_ker)+p[1]+p[2]*X1[iobs,\"filter_upw_mean\"]-p[3]*X1[iobs,\"filter_upw_mean\"]^2\n  }\n  return(f)\n}\n```\n\nPlot the predicted value and the true value, for model 1(recruitment).\n\n```{r}\nplot(m1pred(p1,X1,R,D),R)\nabline(a=0,b=1,col=2)\n```\n\nRelationship between the environment variable and the recruitment, seem decreasing.Thus, I tried several starting points, $t_2$ is always negative. \n\n```{r}\nplot(X1[,\"filter_upw_mean\"],X1[,\"mytilus.rec\"])\n```\n\n\n## 4.4 Fit model 2\n\n\\[\nA_{x, t+1} = R_{x, t}e^{p_2+p_3E_{x, t+1}+p_4E_{x, t+1}^2}+p_1A_{x,t}\n\\]\n\n```{r}\nm2logl=function(p,X1,y){\n  n=dim(X1)[1]\n  f=rep(0,n)\n  for(iobs in 1:n){\n    f[iobs]=X1[iobs,\"mytilus.rec\"]*exp(p[2]+p[3]*X1[iobs,\"new_upw\"]-p[4]*X1[iobs,\"new_upw\"]^2)+p[1]*X1[iobs,\"cover\"]\n  }\n  return(sum((exp(y)-f)^2))\n}\n```\n\n```{r, cache=TRUE}\np0=c(1,0,1,1)\nresm2=nlm(m2logl,p0,hessian=T,print.level=0,X1=X1,y=y,iterlim=1e4,steptol=1e-5)\np2=resm2$estimate\np2\n```\n\n```{r}\nE_hat=p2[3]/(2*p2[4])\nE_hat*sd_upw+mean_upw\n```\n\n\n```{r}\nm2pred=function(p,X1){\n  n=dim(X1)[1]\n  f=rep(0,n)\n  for(iobs in 1:n){\n    f[iobs]=X1[iobs,\"mytilus.rec\"]*exp(p[2]+p[3]*X1[iobs,\"new_upw\"]-p[4]*X1[iobs,\"new_upw\"]^2)+p[1]*X1[iobs,\"cover\"]\n  }\n  return(f)\n}\n```\n\nPlot the predicted value and the true value, for model 2(next year abundance).\n\n```{r}\nplot(m2pred(p2,X1),X1[,\"ycover\"])\nabline(a=0,b=1,col=2)\n```\n\n\n# 5. A simplified model\n\nIf ignore the environment effect in the first Larval production step, and self-increament term $mA_{x,t}$ in the last Adult abundance step, then the model is equivalent to the previous model with second order environment terms, i.e.\n\n\n\\[\ny=K+\\log(\\sum_{i=1}^{n_s}N_{ti}e^{-\\frac{(d_{si}-\\mu_d)^2}{\\sigma_d^2}})+\\beta_1e_{chi}+\\beta_2e_{sst}+\n\\beta_3e_{upw}+\\beta_4e_{chi}^2+\\beta_5e_{sst}^2+\n\\beta_6e_{upw}^2+\\epsilon,\n\\]\n\n\n```{r}\nlibrary(synchrony)\ndata(pisco.data)\ny=subset(pisco.data,year>2000,select=c(mussel_abund)) # species number\ny[y[,1]==0,]=min(y[y[,1]!=0,])/2 # replace 0 to the minimum positive number\ny=log(y) # take log of the species number\n\nN=subset(pisco.data,year<2003,select=c(mussel_abund)) # (past) species number\nD=dist(pisco.data[1:48,1],diag = T,upper = T)\nD=as.matrix(D)\nfor(i in 1:48){\n    for(j in 1:48){\n        if(i>j){\n            D[i,j]=-D[i,j]\n        }\n    }\n}\nE=subset(pisco.data,year<2003,select=c(chl,sst,upwelling)) # Environment variable\nD=as.matrix(D)\n```\n\n```{r}\nlogl2=function(t,y,N,D,E){\n  n=dim(y)[1]\n  f=rep(0,n) # value of the regression function\n  yr=rep(0:2,each=48) # 3 years(0-2) used: 00-03 for X, 01-04 for y\n  for(j in 1:n){\n    Ker=exp(-(D[j%%48+((j%%48)==0)*48,]-t[2])^2/(t[3]^2)) # dispersal kernal (for the 48 sites)\n    Nj=N[(yr[j]*48+1):((yr[j]+1)*48),] # number of species for 48 sites\n    f[j]=t[1]+log(sum(Ker*Nj))+\n      t[4]*E[j,1]+t[5]*E[j,2]+t[6]*E[j,3]+\n      t[7]*E[j,1]^2+t[8]*E[j,2]^2+t[9]*E[j,3]^2 # dispersal + three environment terms\n  }\n  \n  return(sum((y[,1]-f)^2)) # return the objective function\n}\n```\n\n```{r,cache=TRUE}\nt0=c(1,0,1,10,10,20,10,10,20)\nres2=nlm(logl2,t0,hessian=T,print.level=1,y=y,N=N,D=D,E=E,iterlim=1e4,steptol=1e-5)\nt1=res2$estimate\nt1\n```\n\n```{r}\nt1[2]\nt1[3]\n-t1[6]/(2*t1[9])\n```\n\nFor the result parameter $t$, note that $\\mu_d=t_2$, $\\sigma_d=t_3$, $E^*=-\\frac{t_6}{2t_9}$.\n",
    "created" : 1439944831746.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2523560146",
    "id" : "23603CB2",
    "lastKnownWriteTime" : 1439954225,
    "path" : "~/Dropbox/model/hierarchical_model_v2.Rmd",
    "project_path" : "hierarchical_model_v2.Rmd",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "source_on_save" : false,
    "type" : "r_markdown"
}