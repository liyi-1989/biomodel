{
    "contents" : "---\ntitle: \"Estimating dispersal from adult abundance and recruitment\"\nauthor: \"Tarik C. Gouhier\"\ndate: \"July 29, 2015\"\noutput: pdf_document\n---\n\n# Model overview\n\nThe goal is to determine how to estimate the parameters (mean, variance) of a normal dispersal kernel $D$\nfrom spatial patterns of recruitment and abundance across years. The model should consist\nof three successive stages: Larval production ($L_{x, t}$), recruitment ($R_{x, t}$) \nand adult abundance ($A_{x, t+1}$) at location $x$. Below I describe each stage of \nthe model along with the data available.\n\n## Larval production\n\nLarval production $L_{x, t}$ at each site $x$ depends on adult abundance $A_{x, t}$ and environmental\nconditions $E_{x, t}$ such that:\n\n\\[\nL_{x, t} = f \\left( A_{t, x}, E_{t, x} \\right) = p_{t, x} \\cdot A_{t, x} \\cdot E_{t, x}\n\\]\n\nWhere $p_{t, x}$ represents the average larval production per unit of adult abundance.\nIt's fine for $f$ to be linear initially. In reality, this function is probably unimodal with\nrespect to environmental conditions $E$. Larvae $L_{x, t}$ then disperse according to a kernel\nthat can be approximated by a normal distribution. Although we cannot track how larvae \ntravel up and down the coast, we do have access to the larvae that end up arriving at each site.\n\n## Recruitment\n\nRecruitment $R_{x, t}$ represents all the larvae that arrive at a given site $x$\nat time $t$. This quantity depends on the number of larvae that are produced across\nthe coastline $L{x, t}$ at time $t$ and then get dispersed according to our normal \ndispersal kernel $D$ whose parameters we seek to estimate. Using Yi's original model,\nthis kernel could be expressed as:\n\n\\[\nD = L_{x, t} \\cdot e^{e^{-\\frac{\\left(d_{x,i} - \\mu_d\\right)^2}{\\sigma^2_d}}} \n\\]\n\nSumming the larvae produced across all sites $i$ and recruiting to site $x$ based \non environmental conditions $E_{x, t}$ yields recruitment $R_{x, t} = g \\left(L_{\\cdot, t}, E_{x,t} \\right)$\nsuch that:\n\n\\[\nR_{x, t} = k + \\log\\left(\\sum_{i=1}^N L_{i, t} \\cdot e^{-\\frac{\\left(d_{x,i} - \\mu_d\\right)^2}{\\sigma^2_d}} \\right) + \\beta \\cdot E_{x, t} + \\epsilon\n\\]\n\nWhere $\\beta$ is a vector of parameters and $E_{x,t}$ is a $N$-site by 3 matrix containing\nmeasurements of sea surface temperature, upwelling and chl-a.\n\n## Adult abundance\n\nThe final step is to model adult abundance $A_{x, t+1}$ as a function of recruitment\n$R_{x, t}$. The temporal lag is due to the fact that larvae\ntake at least one year to contribute to \"adult abundance\" (they're technically still juveniles).\nLarval survival into adulthood depends on a host of factors including species interactions and \nenvironmental conditions. If we focus exclusively on environmental conditions and ignore species\ninteractions for now, we can model adult abundance $A_{x, t+1} = h \\left(R_{x, t}, E_{x, t+1}\\right)$\nsuch that:\n\n\\[\nA_{x, t+1} = b \\cdot R_{x, t} \\cdot E_{x, t+1}\n\\]\n\nI'm really unsure about the form of function $h$ here. We should use model selection\nto compare linear and more complex relationships (e.g., quadratic).\n\n# Getting the recruitment data\n\nUnfortunately, the recruitment data was not collected at the same locations as the\nadult abundance data. Hence, we need to interpolate the recruitment data using cubic splines\nprior to merging it with the adult abundance data. The clunky code below does just that.\n\n```{r}\n# 2-D interpolation\nlibrary(akima)\n# Load adult data\nload('pisco.RData')\n# Load recruitment data\nrecruits <- read.csv(\"intertidal_recruitment.csv\")\n# Extract adult abundance of mussels (species M. californianus) in the mid zone \nadults <- subset(data.mid.zone, speciesnum == 75)\n# Get unique sites for surveys of adult mussels\nsites.adults <- unique(subset(adults, select = c(\"lat\", \"lon\")))\n# Sort by latitude and longitude\nsites.adults <- sites.adults[order(sites.adults$lat, sites.adults$lon), ]\n# Number of sites for adults\nnsites <- nrow(sites.adults)\n# Aggregate recuitment data by year for mussels only\nrecruits <- aggregate(mytilus.rec ~ lat + lon + year, FUN = mean, \n                      na.rm = TRUE, data = recruits)\n# Sort recruitment data\nrecruits <- recruits[order(recruits$lat, recruits$lon), ]\n# Get unique years for recruitment\nrecruits.years <- unique(recruits$year)\nrecruits.interp <- matrix(nrow = nsites * length(unique(recruits$year)), \n                          ncol = 4)\ncolnames(recruits.interp) <- c(\"year\", \"lon\", \"lat\", \"mytilus.rec\")\n\n# Loop performs 2D interpolation of recruitment data for each unique year\n# and then extracts only the locations where we have adult abundance\nk <- 1\nfor (y in recruits.years) {\n  sub <- subset(recruits, year == y)\n  tmp <- interp(x = sub$lon, y = sub$lat, z = sub$mytilus.rec, \n                xo = sites.adults$lon, yo = sites.adults$lat, \n                linear = FALSE, extrap = TRUE)\n  # Get recruitment at sites where we have abundance only\n  rec <- diag(tmp$z)\n  # Get rid of nonsensical negative recruitment values\n  rec[rec < 0 ] <- 0\n  recruits.interp[k:(k + nsites - 1), ] <- cbind(y, tmp$x, tmp$y, rec)\n  k <- k + nsites\n}\n# Merge adult abundance and interpolated recruitment data\nadults.recruits.merged <- merge(adults, recruits.interp)\nwrite.csv(file = \"adults.recruits.merged.csv\", \n          adults.recruits.merged, row.names = FALSE)\n```\n",
    "created" : 1439944782059.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2907700639",
    "id" : "9DED1414",
    "lastKnownWriteTime" : 1439130007,
    "path" : "~/Dropbox/model/hierarchical_model.Rmd",
    "project_path" : "hierarchical_model.Rmd",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_markdown"
}